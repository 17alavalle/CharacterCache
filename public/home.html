<!DOCTYPE html>
<html>

<head>
  <title>Character Cache</title>
  <link rel="stylesheet" href="stylesheet.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script>
    var firebaseConfig = {
      apiKey: "AIzaSyBO26wJCjlEFzK9GiP7HoIs428bSmr-U0A",
      authDomain: "character-cache-cc142.firebaseapp.com",
      databaseURL: "https://character-cache-cc142.firebaseio.com",
      projectId: "character-cache-cc142",
      storageBucket: "character-cache-cc142.appspot.com",
      messagingSenderId: "1031944349621",
      appId: "1:1031944349621:web:158ad89eda56b305599bfc",
      measurementId: "G-7LMFF4156H"
    };
  </script>
</head>

<body>
  <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-analytics.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.6.1/firebase.js"></script>
  <title>Character Cache</title>
  <script src="/__/firebase/7.14.0/firebase-app.js"></script>
  <script src="/__/firebase/7.14.0/firebase-auth.js"></script>
  <script src="/__/firebase/7.14.0/firebase-firestore.js"></script>
  <script>
    var loggedIn = false;
    $(document).ready(function () {
      $("#login").hide();
      $("#showHideLogin").click(function () {
        if ($("#login").is(":visible")) {
          $("#login").hide();
        }
        else {
          $("#login").show();
        }
        return false;
      });
    });

    $(document).ready(function () {
      $("#logoutButton").hide(); 
      window.onload=checkCookie();
      if(loggedIn==true){
        $('#loginButton').hide(); 
        $('#logoutButton').show(); 
      }
      else{
        $('#logoutButton').hide();
        $('#loginButton').show();
      }
      $('#loginButton').unbind('click').click(function () {
      username = $("#username").val();
        password = $("#password").val();
        checkForUser(username, password);
      });
    });
    $('#logoutButton').unbind('click').click(function () {
      document.cookie = "username=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
      });

    function checkForUser(username, password) {
      loggedIn = false;
      usersRef.where("username", "==", this.username)
        .get()
        .then(function (querySnapshot) {
          querySnapshot.forEach(function (doc) {
            console.log(doc.id, " => ", doc.data());
            if (doc.data().password == this.password) {
              console.log("logged in");
              loggedIn = true;
            }
            else {
              console.log("failed pw: ",doc.data().password);
            }
          });
          if (loggedIn) {
            setCookie(username, password);
          }
          else {
            alert("No login found for this username/password combination.");
          }
        })
        .catch(function (error) {
          console.log("Error getting documents: ", error);
        });

    }

    function getInputVal(id) {
      return document.getElementById(id).value;
    }

    firebase.initializeApp({
      apiKey: 'AIzaSyBO26wJCjlEFzK9GiP7HoIs428bSmr-U0A',
      authDomain: 'character-cache-cc142.firebaseapp.com',
      projectId: 'character-cache-cc142'
    });

    var db = firebase.firestore();
    var usersRef = db.collection("users");

    function setCookie(username,password){
      var d=new Date(); 
      d.setTime(d.getTime() + (30*24*60*60*1000));
      var expires="expires: "+d.toGMTString(); 
      document.cookie="username: " + username + ";" +expires +";path=/"; 
    }

    function getCookie(username){
      var decodedCookie=decodeURIComponent(document.cookie);
      var dc = decodedCookie.split(";");
      for(var i=0; i<dc.length; i++){
        var c=dc[i];
        while(c.charAt(0)==' '){
          c=substring(1);
        }
        if(c.indexOf(username) ==0){
          return c.substring(username.length, c.length);
        }
        return "";
      }
    }

    function checkCookie(){
      console.log("Checking cookie");
      var user=getCookie("username");
      if(user != ""){
        alert("Welcome again " + user);
        loggedIn=true; 
      }
      console.log("loggedIn: "+ loggedIn);
    }

  </script>
  <button onclick="document.getElementById('login').style.display='block'">Login</button>
  <div id="login" class="login">
    <span onclick="document.getElementById('login').style.display='none'" class="close"
      title="Close Modal">&times;</span>
    <form class="modal-content animate" action="/action_page.php"></form>
    <div class="loginContainer">
      <label for="username"><b>Username</b></label>
      <input type="text" placeholder="Enter Username" id="username" required>

      <label for="password"><b>Password</b></label>
      <input type="password" placeholder="Enter Password" id="password" required>

      <button type="submit" id="loginButton">Login</button>
      <button onclick="document.location = 'newUser.html'" id="newUser">New User</button>
      <button id=logoutButton">Logout</button>
      
    </div>

    <div class="loginContainer" style="background-color:#f1f1f1">
      <button type="button" onclick="document.getElementById('login').style.display='none'"
        class="cancelbutton">Cancel</button>
    </div>
    </form>
  </div>
  <div class="navBar">
    <img class="logo" src="images/Logo no border.png" alt="CharacterCache Logo">
    <a href="home.html">Home</a>
    <a href="create.html">Create A Character</a>
    <a href="about.html">About</a>
    <a href="userProfile.html">User Profile</a>
  </div>
  <div class="container home">
    <div class="row">
      <div class="col-md col-sm">
        <a href="create.html">
          <div class="createNewChar">
            <p>+ Create New Character</p>
          </div>
        </a>
      </div>
      <div class="col-md col-sm">
        <div class="characterProfile">
          <div class="homeProfPic">
            <img class="defaultPic" src="images/default profile.png" alt="Default Profile Picture">
          </div>
          <div class="homeCharName">
            <p id="charName">Name</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>

</html>